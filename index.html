<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Simulador SEIRD-M</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #5fad70;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #222;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        label {
            display: flex;
            flex-direction: column;
            font-weight: bold;
        }
        input {
            padding: 6px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-top: 5px;
        }
        button {
            background-color: #0066cc;
            color: white;
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-bottom: 30px;
        }
        button:hover {
            background-color: #0055aa;
        }
        #plot {
            margin-top: 20px;
        }
        #gif-result {
            margin-top: 40px;
            text-align: center;
        }
        #gif-result img {
            max-width: 100%;
            border: 1px solid #ccc;
            border-radius: 10px;
            margin-top: 10px;
        }
        #gif-result a {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
        }
        #gif-result a:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <h1>Simulador SEIRD-M</h1>

    <div class="form-grid">
        <label>Popula√ß√£o Total
            <input id="N" type="number" value="200000">
        </label>
        <label>Taxa de Transmiss√£o (Œ≤)
            <input id="beta" type="number" step="0.001" value="0.5">
        </label>
        <label>Taxa de Quarentena (Œ±)
            <input id="alfa" type="number" step="0.001" value="0.1">
        </label>
        <label>Tempo de Incuba√ß√£o em Dias (œÉ)
            <input id="sigma" type="number" step="0.1" value="5">
        </label>
        <label>Tempo de Recupera√ß√£o em Dias (Œ≥)
            <input id="gamma" type="number" step="0.1" value="10">
        </label>
        <label>Tempo de Recupera√ß√£o em Quarentena (Œ≥q)
            <input id="gammaq" type="number" step="0.1" value="14">
        </label>
        <label>Taxa de Letalidade (Œº)
            <input id="mu" type="number" step="0.001" value="0.01">
        </label>
        <label>Taxa de Letalidade em Quarentena (Œºq)
            <input id="muq" type="number" step="0.001" value="0.005">
        </label>
        <label>Tempo M√°ximo (dias)
            <input id="days" type="number" value="180">
        </label>
        <label>FPS do GIF
            <input id="fps" type="number" value="10" min="1" max="60">
        </label>
    </div>

    <button onclick="simular()">Simular</button>

    <div id="plot"></div>

    <div id="gif-result"></div>

    <script>
        function seirdm(y, beta, sigma, alfa, gamma, gammaq, mu, muq, N) {
            const [S, E, I, Q, R, D] = y;
            const dSdt = -beta * S * I / N;
            const dEdt = beta * S * I / N - sigma * E;
            const dIdt = sigma * E - gamma * I - mu * I - alfa * I;
            const dQdt = alfa * I - (gammaq + muq) * Q;
            const dRdt = gamma * I + gammaq * Q;
            const dDdt = mu * I + muq * Q;
            return [dSdt, dEdt, dIdt, dQdt, dRdt, dDdt];
        }

        function simular() {
            const N = parseFloat(document.getElementById("N").value);
            const beta = parseFloat(document.getElementById("beta").value);
            const alfa = parseFloat(document.getElementById("alfa").value);
            const sigma = 1 / parseFloat(document.getElementById("sigma").value);
            const gamma = 1 / parseFloat(document.getElementById("gamma").value);
            const gammaq = 1 / parseFloat(document.getElementById("gammaq").value);
            const mu = parseFloat(document.getElementById("mu").value);
            const muq = parseFloat(document.getElementById("muq").value);
            const days = parseInt(document.getElementById("days").value);
            const fps = parseInt(document.getElementById("fps").value);

            let t = [...Array(days).keys()];
            let S = [], E = [], I = [], Q = [], R = [], D = [];

            let y = [N - 1, 0, 1, 0, 0, 0];
            for (let i = 0; i < days; i++) {
                S.push(y[0]); E.push(y[1]); I.push(y[2]); Q.push(y[3]); R.push(y[4]); D.push(y[5]);
                let dydt = seirdm(y, beta, sigma, alfa, gamma, gammaq, mu, muq, N);
                y = y.map((val, idx) => val + dydt[idx]);
            }

            const data = [
                { x: t, y: S, name: 'Suscet√≠veis', type: 'scatter' },
                { x: t, y: E, name: 'Expostos', type: 'scatter' },
                { x: t, y: I, name: 'Infectados', type: 'scatter' },
                { x: t, y: Q, name: 'Quarentena', type: 'scatter' },
                { x: t, y: R, name: 'Recuperados', type: 'scatter' },
                { x: t, y: D, name: 'Mortos', type: 'scatter' }
            ];

            Plotly.newPlot('plot', data, {
                title: 'Din√¢mica da Doen√ßa',
                xaxis: { title: 'Dias' },
                yaxis: { title: 'N√∫mero de Pessoas' },
                legend: {
                    orientation: 'h',
                    y: -0.3,
                    x: 0.5,
                    xanchor: 'center',
                    font: { size: 10 }
                },
                margin: { b: 100 }
            });

            gerarGIF(data, t, fps);
        }

        function gerarGIF(data, t, fps) {
            const gifDiv = document.getElementById("gif-result");
            gifDiv.innerHTML = "Gerando GIF...";

            const gif = new GIF({
                workers: 2,
                quality: 10,
                workerScript: 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js',
                width: 600,
                height: 400,
                fps: fps
            });

            const canvas = document.createElement("canvas");
            canvas.width = 600;
            canvas.height = 400;
            const ctx = canvas.getContext("2d");

            const totalFrames = t.length;
            const skip = Math.ceil(totalFrames / 30);

            function renderFrame(i) {
                ctx.clearRect(0, 0, 600, 400);
                const subData = data.map(trace => ({
                    x: trace.x.slice(0, i + 1),
                    y: trace.y.slice(0, i + 1),
                    name: trace.name,
                    type: trace.type
                }));

                Plotly.newPlot(canvas, subData, {
                    title: '',
                    xaxis: { title: 'Dias' },
                    yaxis: { title: 'N√∫mero de Pessoas' },
                    showlegend: false
                }, { staticPlot: true }).then(() => {
                    gif.addFrame(canvas, { copy: true, delay: 1000 / fps });
                    if (i + skip >= totalFrames) {
                        gif.on('finished', function(blob) {
                            const url = URL.createObjectURL(blob);
                            gifDiv.innerHTML = `
                                <h3>GIF da Simula√ß√£o</h3>
                                <img src="${url}" alt="GIF da Simula√ß√£o"/>
                                <br><a href="${url}" download="simulacao.gif">üì• Baixar GIF</a>
                            `;
                        });
                        gif.render();
                    } else {
                        renderFrame(i + skip);
                    }
                });
            }

            renderFrame(0);
        }
    </script>
</body>
</html>
